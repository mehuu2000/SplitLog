# SplitLog 実装メモ（現状同期版）

最終更新: 2026-02-19

## 1. 概要

macOS メニューバー常駐アプリ。  
メニューバーアイコンをクリックすると `NSPopover` を開き、セッションとラップを計測する。

現在は「計測と操作UI」の完成を優先しており、永続化（JSON保存）と起動時復元は未接続。

## 2. 現在の操作仕様

1. `作業開始`  
   - `idle` / `finished` から新規セッション開始
   - ラップ1（`作業1`）を自動作成して選択

2. `ラップ終了`（`running`時のみ有効）  
   - 選択中ラップの経過を確定
   - 新規ラップを作成して自動選択
   - 新規ラップ番号は「選択中」ではなく「既存最大 index + 1」
     - 例: `1,2,3` の状態で `1` を選択していても、次は `4`

3. `作業終了`（メインボタン）  
   - `running`（および内部的に `paused`）から `stopped` へ
   - セッションは破棄せず停止状態として保持

4. `作業再開`（メインボタン）  
   - `stopped` から再開
   - 停止前の選択ラップを継続

5. `リセット`  
   - 右下アイコンボタン
   - 独自確認UIを表示し、確定時に `idle` へ初期化

## 3. ラップ選択・編集仕様

### ラップ選択（ラジオボタン）

- 各ラップ左にラジオボタンを表示
- 選択ラップが時間加算対象
- `running` 中の切替: 直前ラップの加算を確定してから切替
- `stopped` 中の切替: 再開時の加算対象として反映

### ラベル編集

- ラベルクリックでインライン編集開始
- 編集中は白背景で可視化
- フォーカスリングは非表示
- テキスト欄外クリックで確定終了
- 空文字確定時はデフォルト名（`作業N`）へ戻す
- 日本語IME入力の破綻が起きない方式へ調整済み

## 4. 表示仕様（Popover）

### レイアウト

- 左: 円形タイムライン（内側 + 外側リング）
- 右: ラップ一覧（ラベル / 時間 / 下線）
- 上部: 全体経過時間
- 下部: 操作ボタン列

### タイムラインリング

- 内側と外側の2層で時間推移を描画
- 色はラップ単位で同期（リング + 各行の下線）
- 現在はUI検証用に **1周=30秒** の一時設定
  - 本来想定の 12時間/周 ではない（後で戻す前提）

### 色仕様

- 24分割のRGBホイールでラップ色を循環
- 1周後は開始色をオフセットして近接ラップの重複を緩和
- ラベル文字色は黒固定
- ラジオボタン色も黒固定（当たり判定は18x18）

### 一覧スクロール

- ラップ追加時は末尾へ自動スクロール

## 5. 時間計測・更新方式

### 計測モデル

- 減算タイマーは不使用
- `Date` 差分 + 累積秒で算出
- ラップは `accumulatedDuration` と `lastLapActivationAt` で管理
- セッション合計は pause 区間（`DateInterval`）を除外して算出

### 更新間隔

- Popover表示中かつ `running`: 60fps 更新
- 非表示時または非 `running`: 1秒更新（または停止）

## 6. 状態モデル（実装）

`SessionState`:
- `idle`
- `running`
- `paused`（APIはあるが現UIからは遷移させていない）
- `stopped`
- `finished`（型上は存在、現行UI導線では主に `idle/running/stopped` を使用）

補足:
- ボタン統合により、実運用フローは `idle -> running <-> stopped` が中心

## 7. ディレクトリ/アーキテクチャ

```
SplitLog/
  App/
    SplitLogApp.swift
    AppDelegate.swift
  Domain/
    Models/SessionModels.swift
    Services/StopwatchService.swift
    Stores/SessionStore.swift
  Presentation/
    MenuBar/MenuBarController.swift
    Views/SessionPopoverView.swift
    Views/Components/SessionTimelineRingView.swift
```

- `Domain`: 状態・計測ロジック
- `Presentation`: メニューバー制御とSwiftUI表示
- `SessionStore`: プロトコルのみ定義済み（実装未接続）

## 8. テスト状況（`SplitLogTests`）

主な検証済み項目:
- セッション開始/停止/再開
- ラップ終了と新規ラップ採番
- ラップ切替時の加算対象切替
- 停止中ラップ選択の再開反映
- ラベル編集（空文字でデフォルト復帰）
- pause/resume 時の経過時間整合

## 9. 未実装・今後対応

- `SessionStore` の具象実装（JSON保存）
- 起動時の自動終了/復元分岐
- 設定UI（`resumeOnLaunch` など）
- 履歴一覧UI
- ショートカット機能

## 10. 現時点の設計判断メモ

- 作業停止と再開はセッションを維持する設計（終了=破棄ではない）
- ラップは任意切替を許可し、どこからでも再開可能
- ラベル編集は独自の外部クリック確定制御で運用
- UI/挙動の安定性を優先し、永続化は次段で接続する

## 11. 次フェーズ方針（複数セッション対応）

参考UI: `sample/sampleUI_SessionList.png`

### 11.1 目的

- 1セッション固定の運用をやめ、複数セッションを作成・保存・再表示できるようにする
- 各セッションはログとしてローカル保存し、後から参照できるようにする

### 11.2 UI方針（ヘッダー右上）

- ヘッダー右上に「セッション一覧カプセル」を配置（カプセル内で横並びのチップ/タブ形式）
- カプセル内の右端に `︙`（一覧アクション）を配置
- `+`（セッション追加）ボタンはカプセルの外側・右端に独立配置
- セッション名が長い場合は省略表示（`...`）にする
- 選択中セッションは薄い背景で視覚的に強調し、クリックで切り替え可能にする

### 11.3 セッション切替時の挙動

- 一覧のセッションをクリックすると、そのセッションの最終状態（履歴）を右側詳細に表示する
- `stopped` セッションは必要に応じて再開可能にする（再開操作を提供）
- `running` セッションは同時に1つのみとする（単一アクティブ）

### 11.4 セッション追加時の方針

- ヘッダー右端の `+` 押下で新規セッションを作成して一覧末尾へ追加
- 新規作成直後はそのセッションを選択状態にする
- 既存セッションは保持したまま、独立したログとして管理する

### 11.5 保存方針（ローカル）

- `SessionStore` の具象実装を追加し、複数 `SessionRecord` を永続化する
- 保存形式は当面 JSON（`Application Support` 配下）
- 保存対象:
  - 完了/停止済みセッションの履歴
  - 再開対象となるセッションのスナップショット

### 11.6 データモデル拡張方針

- `WorkSession` にセッション表示名（例: `セッション1`）を持たせる案を採用予定
- 一覧表示順は「作成順（昇順）」を初期仕様とする
- 将来的に並び替え/削除を追加できるよう、識別子は `UUID` ベースを維持する

### 11.7 実装順（案）

1. `SessionStore` 具象実装（保存/読み込み）
2. 複数セッション管理用の状態コンテナ追加（選択中セッションIDを含む）
3. ヘッダー右上のセッション一覧UI + `+` ボタン実装
4. セッション切替で詳細表示を差し替える処理実装
5. 再開可能セッションの再開導線を接続
6. テスト追加（採番、切替、保存/復元、単一アクティブ保証）

## 12. 次フェーズ方針（ローカルストレージ完全化）

### 12.1 目的

- アプリ終了後も、次回起動時に直前の状態をそのまま再表示できるようにする
- 履歴参照と作業再開の両方を成立させる
- 表示に必要な情報を欠落なく保存する

### 12.2 保存対象（表示に必要な情報の完全保存）

- セッション一覧表示用
  - `session.id`
  - `session.title`
  - `session.startedAt`
  - `session.endedAt`
- ラップ一覧表示用
  - `lap.id`
  - `lap.sessionId`
  - `lap.index`
  - `lap.startedAt`
  - `lap.endedAt`
  - `lap.accumulatedDuration`
  - `lap.label`
- 復元後の操作継続用
  - `selectedSessionID`
  - 各セッションの `selectedLapID`
  - 各セッションの `state`
  - `pauseStartedAt`
  - `lastLapActivationAt`
  - `completedPauseIntervals`
  - `sessionOrder`
  - `nextSessionNumber`
- 永続フォーマット管理用
  - `schemaVersion`
  - `savedAt`

### 12.3 ストレージ設計方針

- 保存先は `Application Support/SplitLog/sessions.json` を継続
- JSONは「単一スナップショット」で管理し、`Data.write(.atomic)` で原子的に置換
- 復元は起動時1回、保存は状態更新の都度（将来的に必要ならデバウンスを追加）
- 読み込み失敗時はクラッシュさせず、空状態から起動

### 12.4 起動復元ルール

- `sessionOrder` 順で一覧を復元
- `selectedSessionID` が不正な場合は先頭セッションを選択
- `selectedLapID` が不正な場合は `nil` に補正
- `running` 復元時の扱いは仕様を固定する（下の要確認）

### 12.5 既存実装との差分整理

- 現在 `StopwatchService` 内に独自永続化（`PersistedState`）は存在
- ただし `SessionStore` プロトコル経由の保存に未統合
- 今フェーズでは以下を実施する
  - 永続化責務を `SessionStore` 実装へ寄せる
  - `StopwatchService` は保存要求と復元適用に専念
  - 既存 `sessions.json` からの読み替え（移行）を用意して後方互換を維持

### 12.6 実装順

1. `SessionStore` 具象実装（`FileSessionStore`）作成
2. 保存スキーマ `StorageSnapshot` を定義（`schemaVersion` 含む）
3. `StopwatchService` の直接ファイルI/Oを `SessionStore` 呼び出しへ置換
4. 既存 `PersistedState` から `StorageSnapshot` への移行ロジック追加
5. 起動復元時の正規化処理（不正ID補正）を追加
6. テスト追加（保存→復元、移行、破損データ時のフォールバック）

### 12.7 要確認事項（実装前に仕様確定）

1. 起動時に `running` セッションをどう扱うか  
   - A: 自動で `stopped` にして再開待ち  
   - B: 自動で `running` を継続
2. `リセット` 時に履歴も全削除するか  
   - A: 全削除  
   - B: 選択中のみ初期化し履歴は残す
3. 履歴の保持上限  
   - A: 無制限  
   - B: 件数上限（例: 100セッション）
4. セッション削除時の扱い  
   - A: 即時物理削除  
   - B: 論理削除（将来復元可能）

## 13. 次フェーズ方針（アプリ設定UI）

最終更新: 2026-02-20

### 13.1 今回追加する設定項目（確定）

1. テーマカラー設定
   - `color`（現状のカラー実装を維持）
   - `monochrome`（白/黒/灰色ベース、必要に応じて透過でコントラスト差を付与）
   - 対象は「色付きUI全般」
     - 円グラフ
     - ラップ下線
     - 作業ボタン（作業開始/ラップ終了/作業終了）
     - セッション選択系のハイライト等、既存の色付き強調箇所

2. 円表示設定
   - `showTimelineRing = true/false`
   - `false` のとき:
     - セッション詳細の円を非表示
     - セッション名/ラップ/作業ボタンなどの主要要素を右側寄せしてコンパクト化
     - ヘッダーのアイコンと `SplitLog` 表示を非表示
     - ヘッダーは `セッション一覧 + 追加 + 設定` のみ表示
     - Popoverサイズは「円以外の要素が収まるコンパクトサイズ」に縮小

### 13.2 設定UI（確定）

- ヘッダー右側の `+` ボタンの右に歯車アイコンを追加
- 歯車クリックで設定モーダルを表示（既存メモモーダルと同系統）
- モーダル内に上記設定項目を配置
- 閉じる操作で確定反映（即時反映+保持）

### 13.3 永続化方針（確定）

- 保存先は `UserDefaults`（アプリ全体設定）
- 起動時に読み込み、未保存時はデフォルト値を適用
  - `themeMode = color`
  - `showTimelineRing = true`

### 13.4 実装ステップ

1. 設定モデル作成
   - `AppSettings`（`themeMode`, `showTimelineRing`）を定義
   - `ThemeMode` enum（`color`, `monochrome`）を定義

2. 設定ストア作成
   - `AppSettingsStore`（`ObservableObject`）を追加
   - `UserDefaults` 読み書きを集約
   - 値更新時に即時保存する

3. ヘッダーUI拡張
   - `+` の右に設定（歯車）ボタンを追加
   - 設定モーダル開閉状態を `SessionPopoverView` に追加

4. 設定モーダル実装
   - テーマ切替（カラー/モノクロ）
   - 円表示 ON/OFF
   - 閉じる操作を実装

5. 色解決レイヤー追加
   - 現在の色計算に対して「テーマモードを考慮した色解決」を追加
   - `color` は既存色ロジックを維持
   - `monochrome` は一貫したグレースケールパレットへ変換

6. レイアウト分岐実装（円ON/OFF）
   - 円OFF時にタイムラインを非表示
   - ヘッダー左ロゴ領域を非表示
   - コンテンツの横配置・Popoverサイズをコンパクト用に切替

7. 全画面反映確認
   - Popoverの主要コンポーネントへ設定を適用
   - 既存見た目（color + ring ON）が変わらないことを確認

8. テスト追加
   - `UserDefaults` 保存/復元
   - テーマ切替時の設定反映
   - 円表示切替時の状態反映

## 14. 次フェーズ方針（性能最適化・安定化）

最終更新: 2026-02-20

### 14.1 目的

- 見た目と既存操作を維持したまま、CPU負荷と入力時の引っかかりを低減する
- 失敗通知の重複表示リスクを下げる
- 長時間運用時の計算コスト増加を抑える

### 14.2 確定仕様

1. 画面更新頻度（FPS）
   - 円表示ON: `15fps`
   - 円表示OFF: `5fps`
   - 非表示/バックグラウンド: `1fps`

2. 永続化I/O（重さ対策）
   - 採用: 案B（専用非同期ライター）
   - メインスレッドではスナップショット生成のみ行い、書き込みは専用経路へ委譲
   - 連続更新時は最新スナップショットを優先保存（coalescing）
   - 終了時は `flush` 相当で取りこぼしを防ぐ

3. エラートーストの再表示防止
   - エラーイベントは表示後に「消費」してクリアする
   - 画面再表示/再購読時に古いイベントを再表示しない

4. pause区間の計算コスト削減
   - 採用: 案A（`totalPausedDuration` の累積管理）
   - `completedPauseIntervals.reduce(...)` の都度走査をやめ、経過時間計算を `O(1)` 化
   - 既存の整合性（停止/再開時刻の扱い）は維持する

5. セッション名下線幅の再計算最適化
   - 文字列変更時のみ再計算するキャッシュ方式に変更
   - 毎フレームの `NSString.size(...)` 呼び出しを避ける

6. 設定UIの不要 `Task` 排除
   - `Task { @MainActor ... }` を廃止し、メイン文脈で直接 setter を呼び出す
   - 更新順序の不確実性を減らす

### 14.3 実装順

1. 設定UIの `Task` 排除（低リスク）
2. エラートーストイベントの消費クリア
3. セッション名下線幅のキャッシュ導入
4. FPS切替ロジック導入（15/5/1）
5. pause累積時間モデル（`totalPausedDuration`）へ移行
6. 非同期永続化ライター導入（coalescing + flush）
7. 回帰確認（見た目・操作・保存復元）

### 14.4 検証観点

- 連続 `Split` / ラベル編集 / メモ編集で入力遅延が増えていないか
- 円ON/OFF切替時に更新頻度が期待どおり切り替わるか
- 停止/再開を多数回繰り返しても経過時間がずれないか
- 保存失敗時のトーストが重複せず、成功トーストと競合しないか
- 起動復元・終了時保存に取りこぼしがないか

## 15. 追加方針（再調整: 2026-02-20）

### 15.1 今回確定した対応

1. 円OFF時は円計算を停止
   - `showTimelineRing == false` の間は、円描画用の角度計算・セグメント計算・座標計算を実行しない
   - 表示しないUIのための計算を完全にスキップし、CPU負荷を下げる

2. 秒表示配分ロジックの再計算頻度を下げる
   - 対象: `displayedLapSeconds` で行っている秒の再配分ロジック
   - 現在は各更新で並び替えを含む再計算が走るため、表示秒が変わったタイミングのみ再計算するキャッシュ方式へ変更する
   - 補足: 並び替えている対象は、各ラップの「小数部の大きさ（fraction）」と「未選択ラップ群の配列」

3. 保存成功トーストの整合性を強化
   - 「成功トースト」は保存完了を確認してから表示する
   - 失敗時は成功トーストを出さず、エラートーストのみ表示する

5. リング周期を6時間へ戻す
   - 一時設定（30秒/周）を廃止
   - `6時間/周` に変更（2周で12時間）

### 15.2 判断: 今回は見送り

4. JSONの pretty/sorted 出力最適化
   - 変更価値: 低〜中（I/O削減の効果はあるが、現データ量では限定的）
   - 影響: 出力可読性が下がる可能性がある
   - 複雑度: 低
   - 結論: 現時点では見送り。実測で保存I/Oがボトルネック化した時点で再検討する

### 15.3 実装順

1. 円OFF時の円計算停止
2. 秒表示配分ロジックのキャッシュ化
3. 保存成功トーストの表示条件修正
4. リング周期を6時間へ変更
