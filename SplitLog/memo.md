# 作業セッション・ラップ計測 メニューバーアプリ 仕様書（MVP v0.2）

## 1. アプリ概要

macOSのメニューバー常駐型アプリ。

右上メニューバーにアイコンを表示し、クリックするとPopover（小窓UI）が開く。

ユーザーは以下の操作を行う：
- 作業開始
- ラップ終了（次のラップ開始）
- 作業終了

計測対象：

- 全体の作業時間（セッション）
- 各ラップ（作業a, b, c...）の所要時間

計測結果はローカルに保存する。
履歴一覧UIはMVPの対象外（保存のみ先行）。

通知機能はMVPでは使用しない。

---

## 2. ユーザー操作フロー

1. 作業開始ボタンをクリック
   - セッション開始
   - ラップ1開始

2. ラップ終了ボタンをクリック
   - 現在ラップを確定
   - 次ラップを自動開始

3. ラップ終了を繰り返す
   - ラップ2 → ラップ3 → ...

4. 作業終了ボタンをクリック
   - セッション終了
   - 全体時間と各ラップ時間を確定

5. 結果表示
   - 全体作業時間
   - 各ラップ時間一覧

6. ローカルにログ保存

7. 次の作業
   - Finished状態で再度「作業開始」を押すと新規セッションを開始
   - 直前セッションは確定済みログとして保持

8. 再起動時の挙動
   - 実行中セッションが未完了で残っている場合：
     - デフォルト：自動終了
     - 設定で有効化時：復元して継続
   - 自動終了時の `endedAt` 決定ルール：
     - 通常終了イベント時刻を取得できる場合はその時刻を採用
     - 異常終了/強制終了などで終了時刻が不明な場合は、次回起動時刻を `endedAt` として確定（MVP仕様）

---

## 3. UI/UX方針

- メニューバー常駐型（NSStatusItem）
- 通常ウィンドウは使用しない（Windowレス構成）
- NSPopoverで操作UIを表示
- SwiftUIで構築
- Materialを使用したガラス風UI
- 必要最小限のボタン構成

### Popover内表示内容

- 現在の状態（Idle / Running / Finished）
- 全体経過時間
- 現在ラップの経過時間
- ボタン：
  - 作業開始
  - ラップ終了
  - 作業終了
- セッション終了後：
  - ラップ一覧表示
  - 全体時間表示
  - 再度「作業開始」で新規セッション開始

### ラップラベル仕様（MVP）

- ラップのデフォルト名は `作業1`, `作業2`, `作業3` ...。
- ユーザーが各ラップ名を手入力で編集可能。
- 計測中でも編集可能（現在ラップを含む）。
- 未入力時はデフォルト名を表示・保存。

---

## 4. 技術スタック

### 言語
- Swift

### UI
- SwiftUI
- AppKit（NSStatusItem / NSPopover）

### 時間計測方式（重要）

減算型タイマーは使用しない。

設計：

- セッション開始時刻を保存
- 各ラップの開始・終了時刻を保存
- 表示時に Date 差分で経過時間を算出

理由：
- スリープ復帰時にズレない
- 正確な実時間計測が可能

---

## 5. データモデル設計

### Session（全体作業）

- id
- startedAt
- endedAt
- totalDuration（計算または保存）
- laps（Lapの配列）

### Lap（各作業区間）

- id
- sessionId
- index（1,2,3...）
- startedAt
- endedAt
- duration
- label（デフォルト: `作業{index}`、編集可）

---

## 6. 保存設計

### 設定
- UserDefaults（@AppStorage）
  - `resumeOnLaunch: Bool`（デフォルト: `false`）

### ログ保存
MVPは Core Data/SQLite を導入しない。

- 保存先：`Application Support` 配下の JSON ファイル
- 形式：`Session` と `Lap` を `Codable` でシリアライズ
- 理由：
  - 実装コストが低く初期開発が速い
  - 仕様変更に追従しやすい
  - データ量が小さいうちは十分運用可能

将来、履歴一覧・検索・集計要件が増えた時点で Core Data へ移行検討。
移行しやすいように `SessionStore` を抽象化して実装する。

---

## 7. アーキテクチャ構成

- MenuBarController
  - NSStatusItem管理
  - NSPopover制御

- StopwatchService（または SessionTimerService）
  - セッション状態管理（idle / running / finished）
  - ラップ管理
  - 経過時間算出

- SessionStore
  - セッション保存・読み込み

- SettingsStore
  - 設定管理（UserDefaults）

- SwiftUI Views
  - 計測画面
  - 結果画面
  - 履歴一覧画面（将来）
  - 設定画面（将来。`resumeOnLaunch` のUI）

---

## 8. 開発ステップ

1. メニューバー常駐 + Popover骨組み
2. StopwatchService実装（ラップ対応）
3. SessionStoreプロトコル定義（保存実装は後で差し込み）
4. 計測UI表示
5. セッション終了後の結果表示
6. 再起動時の復元/自動終了分岐を実装
7. ローカル保存実装（JSON）
8. UIブラッシュアップ（ガラス効果・余白・アニメーション）
9. 履歴表示機能追加（将来）

---

## 9. 今回の非対象

- 通知機能
- クラウド同期
- アカウント機能
- 外部連携
- 履歴一覧UI
- キーボードショートカット

---

## 10. 目指すアプリ像

- 軽量
- 直感的
- マウス中心で迷わず操作できる（キーボード対応は将来拡張）
- 作業記録に特化
- ミニマルで美しいUI
