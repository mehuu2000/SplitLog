# SplitLog 実装メモ（現状同期版）

最終更新: 2026-02-19

## 1. 概要

macOS メニューバー常駐アプリ。  
メニューバーアイコンをクリックすると `NSPopover` を開き、セッションとラップを計測する。

現在は「計測と操作UI」の完成を優先しており、永続化（JSON保存）と起動時復元は未接続。

## 2. 現在の操作仕様

1. `作業開始`  
   - `idle` / `finished` から新規セッション開始
   - ラップ1（`作業1`）を自動作成して選択

2. `ラップ終了`（`running`時のみ有効）  
   - 選択中ラップの経過を確定
   - 新規ラップを作成して自動選択
   - 新規ラップ番号は「選択中」ではなく「既存最大 index + 1」
     - 例: `1,2,3` の状態で `1` を選択していても、次は `4`

3. `作業終了`（メインボタン）  
   - `running`（および内部的に `paused`）から `stopped` へ
   - セッションは破棄せず停止状態として保持

4. `作業再開`（メインボタン）  
   - `stopped` から再開
   - 停止前の選択ラップを継続

5. `リセット`  
   - 右下アイコンボタン
   - 独自確認UIを表示し、確定時に `idle` へ初期化

## 3. ラップ選択・編集仕様

### ラップ選択（ラジオボタン）

- 各ラップ左にラジオボタンを表示
- 選択ラップが時間加算対象
- `running` 中の切替: 直前ラップの加算を確定してから切替
- `stopped` 中の切替: 再開時の加算対象として反映

### ラベル編集

- ラベルクリックでインライン編集開始
- 編集中は白背景で可視化
- フォーカスリングは非表示
- テキスト欄外クリックで確定終了
- 空文字確定時はデフォルト名（`作業N`）へ戻す
- 日本語IME入力の破綻が起きない方式へ調整済み

## 4. 表示仕様（Popover）

### レイアウト

- 左: 円形タイムライン（内側 + 外側リング）
- 右: ラップ一覧（ラベル / 時間 / 下線）
- 上部: 全体経過時間
- 下部: 操作ボタン列

### タイムラインリング

- 内側と外側の2層で時間推移を描画
- 色はラップ単位で同期（リング + 各行の下線）
- 現在はUI検証用に **1周=30秒** の一時設定
  - 本来想定の 12時間/周 ではない（後で戻す前提）

### 色仕様

- 24分割のRGBホイールでラップ色を循環
- 1周後は開始色をオフセットして近接ラップの重複を緩和
- ラベル文字色は黒固定
- ラジオボタン色も黒固定（当たり判定は18x18）

### 一覧スクロール

- ラップ追加時は末尾へ自動スクロール

## 5. 時間計測・更新方式

### 計測モデル

- 減算タイマーは不使用
- `Date` 差分 + 累積秒で算出
- ラップは `accumulatedDuration` と `lastLapActivationAt` で管理
- セッション合計は pause 区間（`DateInterval`）を除外して算出

### 更新間隔

- Popover表示中かつ `running`: 60fps 更新
- 非表示時または非 `running`: 1秒更新（または停止）

## 6. 状態モデル（実装）

`SessionState`:
- `idle`
- `running`
- `paused`（APIはあるが現UIからは遷移させていない）
- `stopped`
- `finished`（型上は存在、現行UI導線では主に `idle/running/stopped` を使用）

補足:
- ボタン統合により、実運用フローは `idle -> running <-> stopped` が中心

## 7. ディレクトリ/アーキテクチャ

```
SplitLog/
  App/
    SplitLogApp.swift
    AppDelegate.swift
  Domain/
    Models/SessionModels.swift
    Services/StopwatchService.swift
    Stores/SessionStore.swift
  Presentation/
    MenuBar/MenuBarController.swift
    Views/SessionPopoverView.swift
    Views/Components/SessionTimelineRingView.swift
```

- `Domain`: 状態・計測ロジック
- `Presentation`: メニューバー制御とSwiftUI表示
- `SessionStore`: プロトコルのみ定義済み（実装未接続）

## 8. テスト状況（`SplitLogTests`）

主な検証済み項目:
- セッション開始/停止/再開
- ラップ終了と新規ラップ採番
- ラップ切替時の加算対象切替
- 停止中ラップ選択の再開反映
- ラベル編集（空文字でデフォルト復帰）
- pause/resume 時の経過時間整合

## 9. 未実装・今後対応

- `SessionStore` の具象実装（JSON保存）
- 起動時の自動終了/復元分岐
- 設定UI（`resumeOnLaunch` など）
- 履歴一覧UI
- ショートカット機能

## 10. 現時点の設計判断メモ

- 作業停止と再開はセッションを維持する設計（終了=破棄ではない）
- ラップは任意切替を許可し、どこからでも再開可能
- ラベル編集は独自の外部クリック確定制御で運用
- UI/挙動の安定性を優先し、永続化は次段で接続する

## 11. 次フェーズ方針（複数セッション対応）

参考UI: `sample/sampleUI_SessionList.png`

### 11.1 目的

- 1セッション固定の運用をやめ、複数セッションを作成・保存・再表示できるようにする
- 各セッションはログとしてローカル保存し、後から参照できるようにする

### 11.2 UI方針（ヘッダー右上）

- ヘッダー右上に「セッション一覧カプセル」を配置（カプセル内で横並びのチップ/タブ形式）
- カプセル内の右端に `︙`（一覧アクション）を配置
- `+`（セッション追加）ボタンはカプセルの外側・右端に独立配置
- セッション名が長い場合は省略表示（`...`）にする
- 選択中セッションは薄い背景で視覚的に強調し、クリックで切り替え可能にする

### 11.3 セッション切替時の挙動

- 一覧のセッションをクリックすると、そのセッションの最終状態（履歴）を右側詳細に表示する
- `stopped` セッションは必要に応じて再開可能にする（再開操作を提供）
- `running` セッションは同時に1つのみとする（単一アクティブ）

### 11.4 セッション追加時の方針

- ヘッダー右端の `+` 押下で新規セッションを作成して一覧末尾へ追加
- 新規作成直後はそのセッションを選択状態にする
- 既存セッションは保持したまま、独立したログとして管理する

### 11.5 保存方針（ローカル）

- `SessionStore` の具象実装を追加し、複数 `SessionRecord` を永続化する
- 保存形式は当面 JSON（`Application Support` 配下）
- 保存対象:
  - 完了/停止済みセッションの履歴
  - 再開対象となるセッションのスナップショット

### 11.6 データモデル拡張方針

- `WorkSession` にセッション表示名（例: `セッション1`）を持たせる案を採用予定
- 一覧表示順は「作成順（昇順）」を初期仕様とする
- 将来的に並び替え/削除を追加できるよう、識別子は `UUID` ベースを維持する

### 11.7 実装順（案）

1. `SessionStore` 具象実装（保存/読み込み）
2. 複数セッション管理用の状態コンテナ追加（選択中セッションIDを含む）
3. ヘッダー右上のセッション一覧UI + `+` ボタン実装
4. セッション切替で詳細表示を差し替える処理実装
5. 再開可能セッションの再開導線を接続
6. テスト追加（採番、切替、保存/復元、単一アクティブ保証）
